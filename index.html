<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Happy Birthday, Grandpa ðŸŒ™ðŸ’™</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b2b45" />
  <style>
    :root{
      --sky-top: #07142a;       /* dark navy */
      --sky-bottom: #0b3b5a;    /* slightly blue */
      --moon-glow: rgba(255,255,245,0.12);
      --accent: #79c6ff;
      --card-bg: rgba(255,255,255,0.03);
      --muted: #9fb9cc;
      --heart-size: 20px;
      --sprout-dur: 4000; /* ms */
      --branch-dur: 8000;
      --hearts-dur: 12000;
      --slide-dur: 2200;
    }

    /* Basic layout */
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background: linear-gradient(180deg,var(--sky-top),var(--sky-bottom)); color:#eaf6ff;}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px;}
    .card{width:min(1000px,96vw); border-radius:14px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); box-shadow: 0 12px 40px rgba(3,20,34,0.6); padding:18px; overflow:hidden;}
    header{text-align:center;margin-bottom:8px;}
    h1{margin:4px 0;font-size:clamp(24px,3.6vw,40px);color:var(--accent);}
    p.lead{margin:0;color:var(--muted);font-size:clamp(13px,2vw,15px);}

    /* two-column layout */
    .layout{display:flex;gap:18px;align-items:stretch;}
    .left,.right{flex:1;min-height:420px;position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;}
    @media (max-width:880px){ .layout{flex-direction:column;} .left,.right{min-height:300px;} }

    /* Background canvas stack */
    #bgCanvas{position:absolute;inset:0;width:100%;height:100%;z-index:0;border-radius:14px;pointer-events:none;}

    /* scene container (on top of bg) */
    .scene{position:relative;z-index:1;width:100%;max-width:560px;aspect-ratio:4/3;border-radius:12px;overflow:hidden;display:flex;align-items:flex-end;justify-content:center;padding-bottom:24px;}
    .panel{width:100%;height:100%;display:flex;align-items:center;justify-content:center;position:relative;}

    /* svg styles */
    svg{width:100%;height:100%;display:block}
    .trunk{stroke:#6b4533; stroke-width:8; stroke-linecap:round; stroke-linejoin:round; fill:none;}
    .branch{stroke:#6b4533; stroke-width:6; stroke-linecap:round; stroke-linejoin:round; fill:none;}
    .sprout-heart path{fill:#ff6b6b; transition: transform 350ms cubic-bezier(.2,.9,.3,1); transform-origin:center;}
    .heart{opacity:0; transform: scale(0.2); transition: transform 420ms cubic-bezier(.2,.9,.3,1), opacity 420ms;}
    #treeWrap{transition: transform var(--slide-dur) ease-in-out;}

    /* wishes area */
    .wishes{width:100%;display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center;opacity:0;transform:translateY(8px);transition:opacity 600ms ease, transform 600ms ease;}
    .wishes.show{opacity:1;transform:translateY(0);}
    .wish-card{width:100%;max-width:340px;background:rgba(255,255,255,0.04);padding:14px;border-radius:10px;color:#e8fbff;text-align:center;box-shadow: 0 8px 24px rgba(2,12,20,0.4);font-size:15px;}

    /* controls */
    .controls{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap;justify-content:center;}
    button{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:600;background:linear-gradient(180deg,#0e6ea4,#074f7a);color:white;box-shadow:0 6px 18px rgba(2,12,20,0.4);}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--accent);box-shadow:none;}

    /* confetti */
    .confetti{position:absolute;left:0;right:0;bottom:0;height:0;pointer-events:none;}
    .conf-piece{position:absolute;width:8px;height:12px;border-radius:2px;opacity:0;transform:translateY(0) rotate(0deg);}

    /* toast */
    .toast{position:absolute;left:50%;transform:translateX(-50%);bottom:88px;background:rgba(255,255,255,0.95);color:#072433;padding:8px 12px;border-radius:999px;box-shadow:0 10px 30px rgba(2,12,20,0.5);font-weight:600;}
    .small{font-size:13px;color:var(--muted);margin-top:8px;text-align:center;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="application" aria-label="Grandpa birthday app">
      <header>
        <h1>Happy Birthday, Grandpa</h1>
        <p class="lead">Plant the little heart â€” watch a tree bloom with wishes âœ¨</p>
      </header>

      <div class="layout">
        <!-- LEFT: scene -->
        <div class="left">
          <canvas id="bgCanvas" aria-hidden="true"></canvas>

          <div class="scene panel" id="scenePanel">
            <svg viewBox="0 0 1000 750" preserveAspectRatio="xMidYMax meet" id="svgScene" role="img" aria-label="Growing heart tree">
              <rect x="0" y="640" width="1000" height="110" fill="rgba(255,255,255,0.01)"></rect>

              <g id="treeWrap" transform="translate(0,0)">
                <!-- trunk -->
                <path id="trunk" class="trunk" d="M500 640 C500 540, 500 470, 500 420 C500 380, 480 360, 470 340" />
                <!-- branches -->
                <path id="b1" class="branch" d="M470 340 C430 320, 390 300, 350 260" />
                <path id="b2" class="branch" d="M480 340 C520 320, 560 300, 600 260" />
                <path id="b3" class="branch" d="M450 380 C400 360, 360 350, 330 320" />
                <path id="b4" class="branch" d="M510 380 C560 360, 600 350, 640 320" />

                <g id="heartsGroup"></g>

                <!-- sprout (starts at ground) -->
                <g id="sprout" transform="translate(500,620)" class="sprout-heart" aria-hidden="false">
                  <path d="M0 -2 C -10 -2, -10 -14, 0 -18 C 10 -14, 10 -2, 0 -2 Z" fill="#ff6b6b" transform="scale(1.6)"/>
                </g>
              </g>

              <!-- subtle moon silhouette (drawn here but bg canvas also draws moon glow) -->
              <g transform="translate(820,60) scale(0.9)">
                <circle cx="0" cy="0" r="42" fill="rgba(255,255,245,0.9)"></circle>
                <circle cx="14" cy="-6" r="36" fill="rgba(255,255,245,0.12)"></circle>
              </g>
            </svg>

            <div id="confetti" class="confetti" aria-hidden="true"></div>
          </div>
        </div>

        <!-- RIGHT: wishes + controls -->
        <div class="right">
          <div class="wishes" id="wishes">
            <div class="wish-card">You are our family's steady heart.</div>
            <div class="wish-card">Thanks for every story and smile.</div>
            <div class="wish-card">Wishing you calm days and warm tea.</div>
          </div>

          <div class="controls" role="toolbar" aria-label="Controls">
            <button id="plantBtn">Plant the Heart ðŸŒ±</button>
            <button id="replayBtn" class="ghost">Replay</button>
            <button id="toggleBtn" class="ghost" title="Toggle speed">1x / 0.6x</button>
          </div>

          <div class="small">Tip: tap any little heart when it appears for a short message.</div>
        </div>
      </div>
    </div>
  </div>

<script>
/* -------------------------
  Config / timings (ms)
   Sprout: 0 - sproutDur
   Branch draw: next branchDur
   Hearts bloom: next heartsDur
   Slide: slideDur
   Wishes appear after slide
------------------------- */
const timings = {
  sprout: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sprout-dur')) || 4000,
  branch: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--branch-dur')) || 8000,
  hearts: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--hearts-dur')) || 12000,
  slide: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--slide-dur')) || 2200
};
let slowFactor = 1; // toggled to 0.6 for slower overall
const totalEstimate = timings.sprout + timings.branch + timings.hearts + timings.slide + 600;

const plantBtn = document.getElementById('plantBtn');
const replayBtn = document.getElementById('replayBtn');
const toggleBtn = document.getElementById('toggleBtn');
const trunk = document.getElementById('trunk');
const branches = [document.getElementById('b1'), document.getElementById('b2'), document.getElementById('b3'), document.getElementById('b4')];
const heartsGroup = document.getElementById('heartsGroup');
const sprout = document.getElementById('sprout');
const treeWrap = document.getElementById('treeWrap');
const wishes = document.getElementById('wishes');
const confettiRoot = document.getElementById('confetti');
const bgCanvas = document.getElementById('bgCanvas');

let running = false;

/* ---------- Background: canvas night sky, moon glow, floating bubbles ---------- */
(function initBackground(){
  const ctx = bgCanvas.getContext('2d');
  let w, h, dpr;
  const bubbles = [];
  const bubbleCount = 12;

  function resize(){
    dpr = window.devicePixelRatio || 1;
    w = bgCanvas.clientWidth; h = bgCanvas.clientHeight;
    bgCanvas.width = Math.max(300, Math.floor(w * dpr));
    bgCanvas.height = Math.max(200, Math.floor(h * dpr));
    ctx.setTransform(dpr,0,0,dpr,0,0);
    // initialize bubbles with coords relative to canvas
    bubbles.length = 0;
    for(let i=0;i<bubbleCount;i++){
      bubbles.push({
        x: Math.random()*w,
        y: Math.random()*h*0.6,
        r: 6 + Math.random()*36,
        vx: (-0.3 + Math.random()*0.6),
        vy: 0.02 + Math.random()*0.2,
        alpha: 0.04 + Math.random()*0.12,
        phase: Math.random()*Math.PI*2
      });
    }
    draw(0);
  }

  function draw(t){
    // sky gradient
    const g = ctx.createLinearGradient(0,0,0,h);
    g.addColorStop(0, '#07142a');
    g.addColorStop(1, '#0b3b5a');
    ctx.fillStyle = g;
    ctx.fillRect(0,0,w,h);

    // moon glow (radial)
    const moonX = Math.round(w*0.86);
    const moonY = Math.round(h*0.1);
    const moonR = Math.round(Math.min(w,h)*0.08);
    const rg = ctx.createRadialGradient(moonX, moonY, moonR*0.2, moonX, moonY, moonR*3);
    rg.addColorStop(0, 'rgba(255,255,245,0.9)');
    rg.addColorStop(0.25, 'rgba(255,255,245,0.35)');
    rg.addColorStop(1, 'rgba(255,255,245,0.0)');
    ctx.fillStyle = rg;
    ctx.beginPath();
    ctx.arc(moonX, moonY, moonR*3, 0, Math.PI*2);
    ctx.fill();

    // half moon (white with subtle inner cut)
    ctx.beginPath();
    ctx.fillStyle = 'rgba(255,255,245,0.95)';
    ctx.arc(moonX, moonY, moonR, 0, Math.PI*2);
    ctx.fill();
    // crescent cut
    ctx.globalCompositeOperation = 'destination-out';
    ctx.beginPath();
    ctx.arc(moonX + moonR*0.25, moonY - moonR*0.06, moonR*0.96, 0, Math.PI*2);
    ctx.fill();
    ctx.globalCompositeOperation = 'source-over';

    // subtle stars tiny
    for(let i=0;i<30;i++){
      const sx = (i*47)%w + (Math.sin(i+t*0.0001)*10);
      const sy = (i*23)%Math.round(h*0.5);
      ctx.fillStyle = 'rgba(255,255,255,'+(0.02+Math.abs(Math.sin((t+i)/5000))*0.06)+')';
      ctx.fillRect((sx%w), sy, 1,1);
    }

    // animate bubbles
    bubbles.forEach((b, idx)=>{
      b.x += b.vx * (0.6 + Math.sin(b.phase + t*0.001)*0.8);
      b.y -= b.vy * (0.3 + Math.cos(b.phase + t*0.001)*0.6);
      b.phase += 0.01;
      if(b.x < -50) b.x = w + 40;
      if(b.x > w + 50) b.x = -40;
      if(b.y < -80) b.y = h + 20;

      // draw bubble
      const bg = ctx.createRadialGradient(b.x - b.r*0.3, b.y - b.r*0.3, b.r*0.1, b.x, b.y, b.r);
      bg.addColorStop(0, `rgba(255,255,255,${Math.min(0.28,b.alpha+0.05)})`);
      bg.addColorStop(0.6, `rgba(255,255,255,${Math.max(0.02,b.alpha-0.02)})`);
      bg.addColorStop(1, `rgba(255,255,255,0)`);
      ctx.fillStyle = bg;
      ctx.beginPath();
      ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
      ctx.fill();
    });
  }

  function loop(t){ draw(t); bgTick = requestAnimationFrame(loop); }
  let bgTick;
  window.addEventListener('resize', resize);
  resize();
  bgTick = requestAnimationFrame(loop);
})();

/* ---------- utility: sleep ---------- */
const sleep = ms => new Promise(r => setTimeout(r, ms*slowFactor));

/* ---------- reset scene styles to start ---------- */
function resetScene(){
  // clear hearts
  heartsGroup.innerHTML = '';
  // reset strokes for trunk & branches
  [trunk, ...branches].forEach(p=>{
    try{
      const len = p.getTotalLength();
      p.style.strokeDasharray = len;
      p.style.strokeDashoffset = len;
      p.style.transition = 'none';
    }catch(e){}
  });
  // reset sprout transform
  const sproutPath = sprout.querySelector('path');
  if(sproutPath){
    sproutPath.style.transform = 'scale(1.6) translateY(0)';
    sproutPath.style.transition = 'none';
  }
  // reset tree position
  treeWrap.style.transition = 'none';
  treeWrap.style.transform = 'translateX(0)';
  // hide wishes
  wishes.classList.remove('show');
  // remove confetti
  confettiRoot.innerHTML = '';
  running = false;
}

/* ---------- create heart SVG group ---------- */
function createHeartSVG(x, y, color, id){
  const ns = "http://www.w3.org/2000/svg";
  const g = document.createElementNS(ns, 'g');
  g.setAttribute('transform', `translate(${x},${y})`);
  g.classList.add('heart');
  if(id) g.dataset.id = id;
  const path = document.createElementNS(ns,'path');
  path.setAttribute('d', "M0 -2 C -10 -2, -10 -14, 0 -18 C 10 -14, 10 -2, 0 -2 Z");
  path.setAttribute('fill', color);
  path.setAttribute('transform', `scale(${(parseInt(getComputedStyle(document.documentElement).getPropertyValue('--heart-size'))||20)/18})`);
  g.appendChild(path);
  heartsGroup.appendChild(g);
  return g;
}

/* ---------- parametric heart shape points ---------- */
function generateHeartPoints(n, centerX=500, centerY=250, scale=6.0){
  const pts = [];
  for(let i=0;i<n;i++){
    const t = Math.PI*2 * i / n;
    const sx = 16 * Math.pow(Math.sin(t),3);
    const sy = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
    pts.push({x: centerX + sx*scale, y: centerY - sy*scale});
  }
  // shuffle a bit so pop order looks nice
  for(let i=pts.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [pts[i], pts[j]] = [pts[j], pts[i]];
  }
  return pts;
}

/* ---------- reveal hearts staggered ---------- */
async function revealHearts(colors, duration){
  const n = colors.length;
  const pts = generateHeartPoints(n, 500, 220, 6.2);
  const elems = [];
  for(let i=0;i<n;i++){
    const g = createHeartSVG(pts[i].x, pts[i].y, colors[i % colors.length], 'h'+i);
    elems.push(g);
  }
  // stagger
  for(let i=0;i<elems.length;i++){
    await sleep(duration / elems.length / 1.0);
    elems[i].style.opacity = '1';
    elems[i].style.transform = 'scale(1)';
  }
  // small pause after last heart
  await sleep(200);
}

/* ---------- draw trunk & branches ---------- */
async function drawPaths(paths, duration){
  // apply stroke-dasharray lengths then transition strokeDashoffset to 0
  paths.forEach((p, idx) => {
    try{
      const len = p.getTotalLength();
      p.style.strokeDasharray = len;
      p.style.strokeDashoffset = len;
      p.style.transition = 'none';
    }catch(e){}
  });
  // small staggering
  for(let i=0;i<paths.length;i++){
    const p = paths[i];
    try{
      const len = p.getTotalLength();
      p.style.transition = `stroke-dashoffset ${duration/1000}s ease-out`;
      // small delay between each path
      await sleep(220);
      p.style.strokeDashoffset = '0';
    }catch(e){}
  }
  // wait remaining time
  await sleep(80);
}

/* ---------- sprout animation ---------- */
async function sproutGrow(duration){
  const path = sprout.querySelector('path');
  if(!path) return;
  path.style.transition = `transform ${duration/1000}s cubic-bezier(.2,.9,.3,1)`;
  // grow and lift up a bit
  setTimeout(()=> path.style.transform = 'scale(2.2) translateY(-48px)', 20);
  await sleep(duration + 40);
}

/* ---------- slide tree aside ---------- */
async function slideTree(direction='left'){
  const dist = 260;
  treeWrap.style.transition = `transform ${timings.slide/1000 * slowFactor}s ease-in-out`;
  const tx = (direction==='left') ? -dist : dist;
  setTimeout(()=> treeWrap.style.transform = `translateX(${tx}px)`, 40);
  await sleep(timings.slide + 40);
}

/* ---------- confetti burst ---------- */
function confettiBurst(){
  const colors = ['#FF6B6B','#FFD166','#7BD389','#7BC7FF','#FFC9DE'];
  for(let i=0;i<28;i++){
    const el = document.createElement('div');
    el.className = 'conf-piece';
    el.style.left = (40 + Math.random()*420) + 'px';
    el.style.bottom = '14px';
    el.style.width = (6 + Math.random()*8)+'px';
    el.style.height = (8 + Math.random()*12)+'px';
    el.style.background = colors[Math.floor(Math.random()*colors.length)];
    el.style.opacity = '1';
    el.style.transform = `translateY(0) rotate(${Math.random()*360}deg)`;
    el.style.transition = `transform 1400ms cubic-bezier(.2,.8,.2,1), opacity 1400ms linear`;
    confettiRoot.appendChild(el);
    // animate a bit randomly
    setTimeout(()=> {
      el.style.transform = `translateY(-${120 + Math.random()*120}px) rotate(${360 + Math.random()*720}deg)`;
      el.style.opacity = '0.95';
    }, 10 + Math.random()*200);
    setTimeout(()=> el.remove(), 1700 + Math.random()*800);
  }
}

/* ---------- toast on heart click ---------- */
function showToast(text){
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = text;
  document.body.appendChild(t);
  setTimeout(()=> t.style.opacity = '0', 2200);
  setTimeout(()=> t.remove(), 2600);
}

/* clickable hearts: show small messages */
heartsGroup.addEventListener('click', (ev)=>{
  let g = ev.target;
  // find parent g with dataset id
  while(g && g !== heartsGroup){
    if(g.tagName && g.tagName.toLowerCase()==='g' && g.dataset && g.dataset.id) break;
    g = g.parentNode;
  }
  if(g && g.dataset && g.dataset.id){
    const msgs = [
      "We love your stories.",
      "You light up our home.",
      "Thanks for all the cookies!",
      "Your laugh is the best.",
      "Grandpa, you're golden."
    ];
    showToast(msgs[Math.floor(Math.random()*msgs.length)]);
  }
});

/* ---------- main sequence ---------- */
async function runSequence(){
  if(running) return;
  running = true;
  resetScene();

  // tiny pause to let CSS reset
  await sleep(40);

  // 1) sprout grow
  await sproutGrow(timings.sprout);

  // 2) draw trunk + branches
  await drawPaths([trunk, ...branches], timings.branch);

  // 3) hearts bloom (choose colors & count)
  const palette = ['#ff6b6b','#ff9aa2','#ffd6e0','#ffe9f1','#fff1f6','#ffd166','#ffb4a2'];
  const heartsCount = 48;
  const colors = Array.from({length: heartsCount}, (_,i)=>palette[i % palette.length]);
  await revealHearts(colors, timings.hearts);

  // 4) confetti + slide
  confettiBurst();
  await slideTree('left');

  // 5) show wishes
  wishes.classList.add('show');

  // extra confetti
  setTimeout(confettiBurst, 400);

  // finish
  await sleep(1200);
  running = false;
}

/* ---------- wiring ---------- */
plantBtn.addEventListener('click', runSequence);
replayBtn.addEventListener('click', ()=>{
  resetScene();
  setTimeout(runSequence,80);
});
toggleBtn.addEventListener('click', ()=>{
  slowFactor = slowFactor === 1 ? 0.6 : 1;
  toggleBtn.textContent = slowFactor === 1 ? '1x / 0.6x' : '0.6x / 1x';
});

/* start in idle state (sprout visible small) */
resetScene();

/* Register service worker */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js').catch(()=>{/* ignore failures */});
}
</script>
</body>
</html>
